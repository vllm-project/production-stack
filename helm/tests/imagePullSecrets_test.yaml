suite: test imagePullSecrets configuration
templates:
  - deployment-router.yaml
  - deployment-vllm-multi.yaml
  - deployment-cache-server.yaml
  - deployment-lora-controller.yaml
  - ray-cluster.yaml
tests:
  - it: should set imagePullSecrets for router
    set:
      routerSpec:
        enableRouter: true
        imagePullSecrets:
          - name: my-registry-secret
    asserts:
      - template: deployment-router.yaml
        equal:
          path: spec.template.spec.imagePullSecrets
          value:
            - name: my-registry-secret

  - it: should not set imagePullSecrets for router when not specified
    set:
      routerSpec:
        enableRouter: true
    asserts:
      - template: deployment-router.yaml
        notExists:
          path: spec.template.spec.imagePullSecrets

  - it: should set imagePullSecret for serving engine model
    set:
      servingEngineSpec:
        enableEngine: true
        modelSpec:
          - name: "test-model"
            repository: "vllm/vllm-openai"
            tag: "latest"
            modelURL: "facebook/opt-125m"
            imagePullSecret: "model-secret"
            replicaCount: 1
            requestCPU: 1
            requestMemory: "1Gi"
            requestGPU: 1
    asserts:
      - template: deployment-vllm-multi.yaml
        equal:
          path: spec.template.spec.imagePullSecrets
          value:
            - name: model-secret

  - it: should set imagePullSecrets for cache server
    set:
      cacheserverSpec:
        repository: "lmcache/lmstack-cache-server"
        tag: "latest"
        containerPort: 8000
        servicePort: 80
        imagePullSecrets:
          - name: cache-secret
    asserts:
      - template: deployment-cache-server.yaml
        equal:
          path: spec.template.spec.imagePullSecrets
          value:
            - name: cache-secret

  - it: should set imagePullSecrets for lora controller
    set:
      loraController:
        enableLoraController: true
        imagePullSecrets:
          - name: lora-secret
    asserts:
      - template: deployment-lora-controller.yaml
        equal:
          path: spec.template.spec.imagePullSecrets
          value:
            - name: lora-secret

  - it: should set imagePullSecret for ray cluster
    set:
      servingEngineSpec:
        enableEngine: true
        modelSpec:
          - name: "ray-model"
            repository: "vllm/vllm-openai"
            tag: "latest"
            modelURL: "facebook/opt-125m"
            imagePullSecret: "ray-secret"
            replicaCount: 2
            requestCPU: 1
            requestMemory: "1Gi"
            requestGPU: 1
            raySpec:
              enabled: true
              headNode:
                requestCPU: 1
                requestMemory: "1Gi"
                requestGPU: 1
    asserts:
      - template: ray-cluster.yaml
        documentIndex: 0
        equal:
          path: spec.headGroupSpec.template.spec.imagePullSecrets
          value:
            - name: ray-secret
      - template: ray-cluster.yaml
        documentIndex: 0
        equal:
          path: spec.workerGroupSpecs[0].template.spec.imagePullSecrets
          value:
            - name: ray-secret

  - it: should set imagePullSecrets for all components
    set:
      routerSpec:
        enableRouter: true
        imagePullSecrets:
          - name: router-secret
      servingEngineSpec:
        enableEngine: true
        modelSpec:
          - name: "test-model"
            repository: "vllm/vllm-openai"
            tag: "latest"
            modelURL: "facebook/opt-125m"
            imagePullSecret: "model-secret"
            replicaCount: 1
            requestCPU: 1
            requestMemory: "1Gi"
            requestGPU: 1
      loraController:
        enableLoraController: true
        imagePullSecrets:
          - name: lora-secret
      cacheserverSpec:
        repository: "lmcache/lmstack-cache-server"
        tag: "latest"
        containerPort: 8000
        servicePort: 80
        imagePullSecrets:
          - name: cache-secret
    asserts:
      - template: deployment-router.yaml
        equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: router-secret
      - template: deployment-vllm-multi.yaml
        equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: model-secret
      - template: deployment-lora-controller.yaml
        equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: lora-secret
      - template: deployment-cache-server.yaml
        equal:
          path: spec.template.spec.imagePullSecrets[0].name
          value: cache-secret
