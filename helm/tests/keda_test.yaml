suite: test KEDA autoscaling configuration
templates:
  - scaledobject-vllm.yaml
  - deployment-vllm-multi.yaml
tests:
  - it: should not create ScaledObject when keda is not enabled
    set:
      servingEngineSpec:
        enableEngine: true
        modelSpec:
          - name: "test-model"
            repository: "vllm/vllm-openai"
            tag: "latest"
            modelURL: "facebook/opt-125m"
            replicaCount: 1
            requestCPU: 1
            requestMemory: "1Gi"
            requestGPU: 1
            keda:
              enabled: false
    asserts:
      - template: scaledobject-vllm.yaml
        hasDocuments:
          count: 0

  - it: should create ScaledObject when keda is enabled
    set:
      servingEngineSpec:
        enableEngine: true
        modelSpec:
          - name: "test-model"
            repository: "vllm/vllm-openai"
            tag: "latest"
            modelURL: "facebook/opt-125m"
            replicaCount: 1
            requestCPU: 1
            requestMemory: "1Gi"
            requestGPU: 1
            keda:
              enabled: true
              minReplicaCount: 1
              maxReplicaCount: 3
              triggers:
                - type: prometheus
                  metadata:
                    serverAddress: http://prometheus-operated.monitoring.svc:9090
                    metricName: vllm:num_requests_waiting
                    query: vllm:num_requests_waiting
                    threshold: '5'
    asserts:
      - template: scaledobject-vllm.yaml
        hasDocuments:
          count: 1
      - template: scaledobject-vllm.yaml
        equal:
          path: metadata.name
          value: RELEASE-NAME-test-model-scaledobject
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.minReplicaCount
          value: 1
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.maxReplicaCount
          value: 3

  - it: should use default trigger when checks are not provided
    set:
      servingEngineSpec:
        enableEngine: true
        modelSpec:
          - name: "test-model-default"
            repository: "vllm/vllm-openai"
            tag: "latest"
            modelURL: "facebook/opt-125m"
            replicaCount: 1
            requestCPU: 1
            requestMemory: "1Gi"
            requestGPU: 1
            keda:
              enabled: true
              minReplicaCount: 1
              maxReplicaCount: 5
    asserts:
      - template: scaledobject-vllm.yaml
        hasDocuments:
          count: 1
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.triggers[0].type
          value: prometheus
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.triggers[0].metadata.query
          value: vllm:num_requests_waiting{model="test-model-default"}

  - it: should support advanced KEDA configuration
    set:
      servingEngineSpec:
        enableEngine: true
        modelSpec:
          - name: "test-model-advanced"
            repository: "vllm/vllm-openai"
            tag: "latest"
            modelURL: "facebook/opt-125m"
            replicaCount: 1
            requestCPU: 1
            requestMemory: "1Gi"
            requestGPU: 1
            keda:
              enabled: true
              minReplicaCount: 0
              maxReplicaCount: 10
              pollingInterval: 10
              cooldownPeriod: 60
              idleReplicaCount: 0
              initialCooldownPeriod: 30
              fallback:
                failureThreshold: 5
                replicas: 2
              advanced:
                restoreToOriginalReplicaCount: true
                horizontalPodAutoscalerConfig:
                  name: my-hpa
                  behavior:
                    scaleDown:
                      stabilizationWindowSeconds: 300
    asserts:
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.pollingInterval
          value: 10
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.cooldownPeriod
          value: 60
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.idleReplicaCount
          value: 0
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.initialCooldownPeriod
          value: 30
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.fallback.failureThreshold
          value: 5
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.fallback.replicas
          value: 2
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.advanced.restoreToOriginalReplicaCount
          value: true
      - template: scaledobject-vllm.yaml
        equal:
          path: spec.advanced.horizontalPodAutoscalerConfig.name
          value: my-hpa
